<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enviar audio al runner</title>
<style>
  body{font-family:system-ui,Inter,Segoe UI,Roboto;max-width:560px;margin:40px auto;padding:0 16px}
  .card{padding:20px;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
  button{padding:12px 16px;border-radius:999px;border:0;background:#2563eb;color:white;font-weight:600}
  button[disabled]{opacity:.5;cursor:not-allowed}
  input, .pill{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb}
  .row{display:flex;gap:12px;align-items:center}
  .mt{margin-top:14px}
</style>
<div class="card">
  <h2>Enviar audio a un runner</h2>
  <div class="row mt">
    <input id="code" placeholder="C√≥digo del runner (p.ej. RUN-482913)" style="flex:1"/>
  </div>
  <div class="row mt">
    <input id="name" placeholder="Tu nombre (opcional)" style="flex:1"/>
  </div>
  <div class="row mt">
    <button id="recBtn">üéôÔ∏è Grabar (30s m√°x)</button>
    <span id="timer" class="pill">00:00</span>
  </div>
  <p id="status" class="mt"></p>
</div>

<script>
const MAX_S = 30;
let media, chunks=[], rec, t, secs=0;

const codeEl = document.getElementById('code');
const nameEl = document.getElementById('name');
const btn = document.getElementById('recBtn');
const statusEl = document.getElementById('status');
const timer = document.getElementById('timer');

function fmt(n){return String(n).padStart(2,'0')}
function setTimer(s){ timer.textContent = `${fmt(Math.floor(s/60))}:${fmt(s%60)}` }

async function start() {
  const runCode = codeEl.value.trim();
  if(!runCode){ alert('Introduce el c√≥digo del runner'); return; }
  media = await navigator.mediaDevices.getUserMedia({ audio: true });
  rec = new MediaRecorder(media, { mimeType: 'audio/webm' });
  chunks=[]; secs=0; setTimer(0);
  t = setInterval(()=>{ secs++; setTimer(secs); if(secs>=MAX_S) stop(); },1000);
  rec.ondataavailable = e => chunks.push(e.data);
  rec.onstop = async () => {
    clearInterval(t);
    const blob = new Blob(chunks, { type: 'audio/webm' });
    await uploadAndNotify(runCode, blob, nameEl.value.trim());
  };
  rec.start();
  btn.textContent='‚èπÔ∏è Parar'; btn.onclick=stop;
  statusEl.textContent='Grabando‚Ä¶';
}

function stop(){
  try{ rec?.stop(); }catch(e){}
  media?.getTracks().forEach(tr=>tr.stop());
  btn.textContent='üéôÔ∏è Grabar (30s m√°x)'; btn.onclick=start;
}

btn.onclick = start;

// TODO: rellena tus variables:
const SUPABASE_URL = 'https://TU-PROYECTO.supabase.co';
const SUPABASE_ANON_KEY = 'TU_ANON_KEY';
const BUCKET = 'audios';

async function uploadAndNotify(runCode, blob, sender){
  statusEl.textContent='Subiendo‚Ä¶';
  // 1) Subir a Storage
  const fileName = `${runCode}/${Date.now()}.webm`;
  const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${BUCKET}/${fileName}`, {
    method:'POST',
    headers:{ 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'audio/webm', 'x-upsert': 'true' },
    body: blob
  });
  if(!res.ok){ statusEl.textContent='Error al subir audio'; return; }

  // 2) URL firmada (1h)
  const signRes = await fetch(`${SUPABASE_URL}/storage/v1/object/sign/${BUCKET}/${fileName}?expiresIn=3600`, {
    method:'POST',
    headers:{ 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
  });
  const { signedURL } = await signRes.json();

  // 3) Registrar y notificar (Edge Function / RPC)
  const payload = { runCode, url: `${SUPABASE_URL}${signedURL}`, duration_s: Math.min(secs, MAX_S), sender };
  const fn = await fetch(`${SUPABASE_URL}/functions/v1/notify_new_audio`, {
    method:'POST',
    headers:{ 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });

  statusEl.textContent = fn.ok ? '¬°Enviado! üéâ' : 'Enviado, pero no se pudo notificar.';
}
</script>
