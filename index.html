<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enviar audio al runner</title>
<style>
  body{font-family:system-ui,Inter,Segoe UI,Roboto;max-width:560px;margin:40px auto;padding:0 16px}
  .card{padding:20px;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
  button{padding:12px 16px;border-radius:999px;border:0;background:#2563eb;color:white;font-weight:600}
  button[disabled]{opacity:.5;cursor:not-allowed}
  input, .pill{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb}
  .row{display:flex;gap:12px;align-items:center}
  .mt{margin-top:14px}
</style>
<div class="card">
  <h2>Enviar audio a un runner</h2>
  <div class="row mt">
    <input id="code" placeholder="C√≥digo del runner (p.ej. RUN-482913)" style="flex:1"/>
  </div>
  <div class="row mt">
    <input id="name" placeholder="Tu nombre (opcional)" style="flex:1"/>
  </div>
  <div class="row mt">
    <button id="recBtn">üéôÔ∏è Grabar (30s m√°x)</button>
    <span id="timer" class="pill">00:00</span>
  </div>
  <p id="status" class="mt" id="status"></p>
</div>

<script>
/** ====== TUS CONSTANTES DE SUPABASE ====== */
const SUPABASE_URL = 'https://pduysvaqzkizgxojyfyh.supabase.co';
const ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkdXlzdmFxemtpemd4b2p5ZnloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNTIzNjQsImV4cCI6MjA3MjgyODM2NH0.OAcF_jrVxvszxxfz6mHGBqs2hp6hDAwDwWKgIU_XvR8';

/** ====== L√ìGICA DE GRABACI√ìN ====== */
const MAX_S = 30;
let media, chunks=[], rec, t, secs=0;

const codeEl = document.getElementById('code');
const nameEl = document.getElementById('name');
const btn = document.getElementById('recBtn');
const statusEl = document.getElementById('status');
const timer = document.getElementById('timer');

function fmt(n){return String(n).padStart(2,'0')}
function setTimer(s){ timer.textContent = `${fmt(Math.floor(s/60))}:${fmt(s%60)}` }

async function start() {
  const runCode = codeEl.value.trim();
  if(!runCode){ alert('Introduce el c√≥digo del runner'); return; }
  media = await navigator.mediaDevices.getUserMedia({ audio: true });
  rec = new MediaRecorder(media, { mimeType: 'audio/webm' });
  chunks=[]; secs=0; setTimer(0);
  t = setInterval(()=>{ secs++; setTimer(secs); if(secs>=MAX_S) stop(); },1000);
  rec.ondataavailable = e => chunks.push(e.data);
  rec.onstop = async () => {
    clearInterval(t);
    const blob = new Blob(chunks, { type: 'audio/webm' });
    await uploadAndNotify(runCode, blob, nameEl.value.trim());
  };
  rec.start();
  btn.textContent='‚èπÔ∏è Parar'; btn.onclick=stop;
  statusEl.textContent='Grabando‚Ä¶';
}

function stop(){
  try{ rec?.stop(); }catch(e){}
  media?.getTracks().forEach(tr=>tr.stop());
  btn.textContent='üéôÔ∏è Grabar (30s m√°x)'; btn.onclick=start;
}

btn.onclick = start;

/** ====== SUBIR A STORAGE + FIRMAR + NOTIFICAR ====== */
async function uploadAndNotify(runCode, blob, sender){
  try {
    statusEl.textContent='Subiendo‚Ä¶';

    // -------- 1) SUBIR A STORAGE --------
    const fileName = `${runCode}/${Date.now()}.webm`;
    const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${encodeURIComponent('audios')}/${encodeURIComponent(fileName)}`;

    const up = await fetch(uploadUrl, {
      method:'POST',
      headers:{
        'Authorization': `Bearer ${ANON}`,
        'apikey': ANON,
        'Content-Type': 'audio/webm',
        'x-upsert': 'true'
      },
      body: blob
    });

    if (!up.ok) {
      const txt = await up.text();
      console.error('Upload error', up.status, txt);
      statusEl.textContent = `Error al subir audio (${up.status}).`;
      return;
    }

    // -------- 2) CREAR URL FIRMADA (1h) --------
    statusEl.textContent = 'Creando URL firmada‚Ä¶';

    const signUrl = `${SUPABASE_URL}/storage/v1/object/sign/${encodeURIComponent('audios')}/${encodeURIComponent(fileName)}`;
    const sign = await fetch(signUrl, {
      method:'POST',
      headers:{
        'Authorization': `Bearer ${ANON}`,
        'apikey': ANON,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ expiresIn: 3600 }) // <-- body JSON (importante)
    });

    if (!sign.ok) {
      const txt = await sign.text();
      console.error('Sign error', sign.status, txt);
      statusEl.textContent = `Error al firmar URL (${sign.status}).`;
      return;
    }

    const data = await sign.json();
    const signedURL = data?.signedURL;
    if (!signedURL) {
      console.error('Sign response sin signedURL:', data);
      statusEl.textContent = 'No se obtuvo signedURL';
      return;
    }
    const finalUrl = `${SUPABASE_URL}${signedURL}`;

    // -------- 3) LLAMAR A LA API DE VERCEL --------
    statusEl.textContent = 'Notificando al runner‚Ä¶';

    const notifyRes = await fetch('/api/notify_new_audio', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
        runCode,
        url: finalUrl,
        duration_s: Math.min(secs, MAX_S),
        sender
      })
    });

    const notifyTxt = await notifyRes.text();
    if (!notifyRes.ok) {
      console.error('Notify error', notifyRes.status, notifyTxt);
      statusEl.textContent = `Error al notificar (${notifyRes.status}).`;
      return;
    }

    console.log('Notify OK', notifyTxt);
    statusEl.textContent = '¬°Enviado! üéâ';
  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Error inesperado. Revisa la consola.';
  }
}
</script>
