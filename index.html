<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enviar audio al runner</title>
<style>
  body{font-family:system-ui,Inter,Segoe UI,Roboto;max-width:560px;margin:40px auto;padding:0 16px}
  .card{padding:20px;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
  button{padding:12px 16px;border-radius:999px;border:0;background:#2563eb;color:white;font-weight:600}
  button[disabled]{opacity:.5;cursor:not-allowed}
  input, .pill{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb}
  .row{display:flex;gap:12px;align-items:center}
  .mt{margin-top:14px}
</style>
<div class="card">
  <h2>Enviar audio a un runner</h2>
  <div class="row mt">
    <input id="code" placeholder="C√≥digo del runner (p.ej. RUN-482913)" style="flex:1"/>
  </div>
  <div class="row mt">
    <input id="name" placeholder="Tu nombre (opcional)" style="flex:1"/>
  </div>
  <div class="row mt">
    <button id="recBtn">üéôÔ∏è Grabar (30s m√°x)</button>
    <span id="timer" class="pill">00:00</span>
  </div>
  <p id="status" class="mt"></p>
</div>

<script>
/** ====== TUS CONSTANTES DE SUPABASE ====== */
const SUPABASE_URL = 'https://pduysvaqzkizgxojyfyh.supabase.co';
const ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkdXlzdmFxemtpemd4b2p5ZnloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNTIzNjQsImV4cCI6MjA3MjgyODM2NH0.OAcF_jrVxvszxxfz6mHGBqs2hp6hDAwDwWKgIU_XvR8';

/** ====== L√ìGICA DE GRABACI√ìN ====== */
const MAX_S = 30;
let media, chunks=[], rec, t, secs=0;

const codeEl = document.getElementById('code');
const nameEl = document.getElementById('name');
const btn = document.getElementById('recBtn');
const statusEl = document.getElementById('status');
const timer = document.getElementById('timer');

function fmt(n){return String(n).padStart(2,'0')}
function setTimer(s){ timer.textContent = `${fmt(Math.floor(s/60))}:${fmt(s%60)}` }

btn.addEventListener('click', start);

async function start() {
  const runCode = codeEl.value.trim();
  if(!runCode){ alert('Introduce el c√≥digo del runner'); return; }

  try {
    // Pide micro
    statusEl.textContent = 'Solicitando acceso al micr√≥fono‚Ä¶';
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // Fallback de MIME por compatibilidad
    let options = {};
    if (window.MediaRecorder) {
      if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
        options = { mimeType: 'audio/webm;codecs=opus' };
      } else if (MediaRecorder.isTypeSupported('audio/webm')) {
        options = { mimeType: 'audio/webm' };
      }
    }

    media = stream;
    rec = new MediaRecorder(stream, options);
    chunks=[]; secs=0; setTimer(0);

    t = setInterval(()=>{ secs++; setTimer(secs); if(secs>=MAX_S) stop(); },1000);
    rec.ondataavailable = e => chunks.push(e.data);
    rec.onerror = e => { console.error('MediaRecorder error', e); statusEl.textContent = 'Error de grabaci√≥n.'; stop(); };
    rec.onstop = async () => {
      clearInterval(t);
      const blob = new Blob(chunks, { type: 'audio/webm' });
      await uploadAndNotify(runCode, blob, nameEl.value.trim());
    };

    rec.start();
    btn.textContent='‚èπÔ∏è Parar';
    btn.removeEventListener('click', start);
    btn.addEventListener('click', stop);
    statusEl.textContent='Grabando‚Ä¶';

  } catch (err) {
    console.error('getUserMedia error:', err);
    if (err.name === 'NotAllowedError') {
      statusEl.textContent = 'Permiso de micr√≥fono denegado. Habil√≠talo en el candado de la barra del navegador.';
    } else if (err.name === 'NotFoundError') {
      statusEl.textContent = 'No se encontr√≥ micr√≥fono.';
    } else {
      statusEl.textContent = 'No se pudo acceder al micr√≥fono.';
    }
  }
}

function stop(){
  try{ rec?.stop(); }catch(e){}
  try{ media?.getTracks().forEach(tr=>tr.stop()); }catch(e){}
  clearInterval(t);
  btn.textContent='üéôÔ∏è Grabar (30s m√°x)';
  btn.removeEventListener('click', stop);
  btn.addEventListener('click', start);
}

/** ====== SUBIR A STORAGE + FIRMAR + NOTIFICAR ====== */
async function uploadAndNotify(runCode, blob, sender){
  try {
    statusEl.textContent='Subiendo‚Ä¶';

    // 1) Upload
    const fileName = `${runCode}/${Date.now()}.webm`;
    const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${encodeURIComponent('audios')}/${encodeURIComponent(fileName)}`;

    const up = await fetch(uploadUrl, {
      method:'POST',
      headers:{
        'Authorization': `Bearer ${ANON}`,
        'apikey': ANON,
        'Content-Type': 'audio/webm',
        'x-upsert': 'true'
      },
      body: blob
    });
    if (!up.ok) {
      console.error('Upload error', up.status, await up.text());
      statusEl.textContent = `Error al subir audio (${up.status}).`;
      return;
    }

    // 2) Sign (POST + JSON)
    statusEl.textContent='Creando URL firmada‚Ä¶';
    const signUrl = `${SUPABASE_URL}/storage/v1/object/sign/${encodeURIComponent('audios')}/${encodeURIComponent(fileName)}`;
    const sign = await fetch(signUrl, {
      method:'POST',
      headers:{
        'Authorization': `Bearer ${ANON}`,
        'apikey': ANON,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ expiresIn: 3600 })
    });
    if (!sign.ok) {
      console.error('Sign error', sign.status, await sign.text());
      statusEl.textContent = `Error al firmar URL (${sign.status}).`;
      return;
    }
    const { signedURL } = await sign.json();
    if (!signedURL) {
      statusEl.textContent = 'No se obtuvo signedURL';
      return;
    }
    const finalUrl = `${SUPABASE_URL}${signedURL}`;

    // 3) Notify
    statusEl.textContent='Notificando al runner‚Ä¶';
    const notify = await fetch('/api/notify_new_audio', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ runCode, url: finalUrl, duration_s: Math.min(secs, MAX_S), sender })
    });
    if (!notify.ok) {
      console.error('Notify error', notify.status, await notify.text());
      statusEl.textContent = `Error al notificar (${notify.status}).`;
      return;
    }

    statusEl.textContent='¬°Enviado! üéâ';
  } catch (e) {
    console.error(e);
    statusEl.textContent='Error inesperado. Revisa la consola.';
  }
}
</script>