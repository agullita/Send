<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enviar audio al runner</title>
<style>
  body{font-family:system-ui,Inter,Segoe UI,Roboto;max-width:560px;margin:40px auto;padding:0 16px}
  .card{padding:20px;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
  button{padding:12px 16px;border-radius:999px;border:0;background:#2563eb;color:white;font-weight:600}
  button[disabled]{opacity:.5;cursor:not-allowed}
  input, .pill{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb}
  .row{display:flex;gap:12px;align-items:center}
  .mt{margin-top:14px}
</style>
<div class="card">
  <h2>Enviar audio a un runner</h2>
  <div class="row mt">
    <input id="code" placeholder="C√≥digo del runner (p.ej. RUN-482913)" style="flex:1"/>
  </div>
  <div class="row mt">
    <input id="name" placeholder="Tu nombre (opcional)" style="flex:1"/>
  </div>
  <div class="row mt">
    <button id="recBtn">üéôÔ∏è Grabar (30s m√°x)</button>
    <span id="timer" class="pill">00:00</span>
  </div>
  <p id="status" class="mt" id="status"></p>
</div>

<script>
const SUPABASE_URL = 'https://pduysvaqzkizgxojyfyh.supabase.co';
const ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkdXlzdmFxemtpemd4b2p5ZnloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNTIzNjQsImV4cCI6MjA3MjgyODM2NH0.OAcF_jrVxvszxxfz6mHGBqs2hp6hDAwDwWKgIU_XvR8';

async function uploadAndNotify(runCode, blob, sender){
  const statusEl = document.getElementById('status');
  try {
    statusEl.textContent='Subiendo‚Ä¶';

    // 1) Upload
    const fileName = `${runCode}/${Date.now()}.webm`;
    const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${encodeURIComponent('audios')}/${encodeURIComponent(fileName)}`;

    const up = await fetch(uploadUrl, {
      method:'POST',
      headers:{
        'Authorization': `Bearer ${ANON}`,
        'apikey': ANON,
        'Content-Type': 'audio/webm',
        'x-upsert': 'true'
      },
      body: blob
    });
    if (!up.ok) {
      console.error('Upload error', up.status, await up.text());
      statusEl.textContent = `Error al subir audio (${up.status}).`;
      return;
    }

    // 2) Sign (POST + JSON)
    statusEl.textContent='Creando URL firmada‚Ä¶';
    const signUrl = `${SUPABASE_URL}/storage/v1/object/sign/${encodeURIComponent('audios')}/${encodeURIComponent(fileName)}`;
    const sign = await fetch(signUrl, {
      method:'POST',
      headers:{
        'Authorization': `Bearer ${ANON}`,
        'apikey': ANON,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ expiresIn: 3600 })
    });
    if (!sign.ok) {
      console.error('Sign error', sign.status, await sign.text());
      statusEl.textContent = `Error al firmar URL (${sign.status}).`;
      return;
    }
    const { signedURL } = await sign.json();
    if (!signedURL) {
      statusEl.textContent = 'No se obtuvo signedURL';
      return;
    }
    const finalUrl = `${SUPABASE_URL}${signedURL}`;

    // 3) Notify
    statusEl.textContent='Notificando al runner‚Ä¶';
    const notify = await fetch('/api/notify_new_audio', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ runCode, url: finalUrl, duration_s: Math.min(secs, 30), sender })
    });
    if (!notify.ok) {
      console.error('Notify error', notify.status, await notify.text());
      statusEl.textContent = `Error al notificar (${notify.status}).`;
      return;
    }

    statusEl.textContent='¬°Enviado! üéâ';
  } catch (e) {
    console.error(e);
    statusEl.textContent='Error inesperado. Revisa la consola.';
  }
}
</script>


